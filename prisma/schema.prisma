// Prisma Schema for HaDEA Order Entry (EF-HaDEA)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════

enum OrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  OUTBOUND_PREPARING
  OUTBOUND_SHIPPED
  OUTBOUND_DELIVERED
  SAMPLING_IN_PROGRESS
  SAMPLE_PREPARING
  SAMPLE_SHIPPED
  SAMPLE_DELIVERED
  COMPLETED
  CANCELLED
}

enum ShipmentType {
  OUTBOUND
  SAMPLE
}

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
  CANCELLED
}

enum CarrierType {
  UPS
  DHL
}

enum DocumentType {
  BOX_CONTENT_LABEL_OUTBOUND
  BOX_CONTENT_LABEL_SAMPLE
  NON_ADR_DECLARATION
  SHIPPING_LABEL_OUTBOUND
  SHIPPING_LABEL_SAMPLE
  PACKING_LIST
  COMMERCIAL_INVOICE
  PROOF_OF_DELIVERY_OUTBOUND
  PROOF_OF_DELIVERY_SAMPLE
}

enum StockMovementType {
  ADJUSTMENT
  ORDER_ALLOCATION
  ORDER_CANCELLATION
  RECEIPT
  MANUAL_DECREASE
  MANUAL_INCREASE
}

enum UserRole {
  ADMIN
  OPERATIONS_MANAGER
  WAREHOUSE_OPERATOR
  VIEWER
}

// Geographic region classification (for shipping scenario lookup)
enum GeographicRegion {
  EU
  NON_EU_EUROPE  // Maps to 'Non-EU Europe' in AREA sheet
  NON_EUROPE     // Maps to 'Non-Europe' in AREA sheet
}

// Item category for BOM classification
enum ItemCategory {
  TUBE
  CONTAINER
  PACKAGING
  DOCUMENTATION
  LABEL
  ABSORBENT
  COOLING
  OTHER
}

// Box-level status tracking
enum BoxStatus {
  PENDING
  PACKED
  SHIPPED_OUTBOUND
  AT_SITE
  SHIPPED_SAMPLE
  AT_LAB
  COMPLETED
  LOST
  DAMAGED
  RETURNED
}

// Audit log actions
enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// Label template types for document generation
enum LabelTemplateType {
  OUTBOUND_CONTENT    // Box content label for outbound shipment
  SAMPLE_CONTENT      // Box content label for sample return
  SHIPPING_LABEL      // Carrier shipping label
  COMMERCIAL_INVOICE  // Customs invoice
  NON_ADR            // Non-ADR declaration
  PACKING_LIST       // Packing list
}

// ═══════════════════════════════════════════════════════════════════
// USERS & AUTHENTICATION
// ═══════════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  passwordHash  String    @map("password_hash")
  role          UserRole  @default(VIEWER)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  approvedOrders   Order[]         @relation("ApprovedBy")
  collectionBookedOrders Order[]   @relation("CollectionBookedBy")
  stockMovements   StockMovement[]

  // OrderBox relations
  outboundLabelsCreated OrderBox[] @relation("OutboundLabelCreatedBy")
  sampleLabelsCreated   OrderBox[] @relation("SampleLabelCreatedBy")
  boxesPicked           OrderBox[] @relation("BoxPickedBy")
  boxesChecked          OrderBox[] @relation("BoxCheckedBy")
  boxesVerified         OrderBox[] @relation("BoxVerifiedBy")

  // Audit
  auditLogs             AuditLog[]

  @@map("users")
}

// ═══════════════════════════════════════════════════════════════════
// REFERENCE TABLES
// ═══════════════════════════════════════════════════════════════════

model Country {
  code      String           @id @db.Char(2)
  name      String           @db.VarChar(100)
  region    GeographicRegion
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  sites     Site[]
  labs      Lab[]
  stockItems StockItem[]     @relation("ItemCountryOfOrigin")

  @@map("countries")
}

model ShippingScenario {
  id              String           @id @default(cuid())
  scenarioNumber  Int              @unique @map("scenario_number")
  regionFrom      GeographicRegion @map("region_from")
  regionTo        GeographicRegion @map("region_to")
  combi           String           @unique @db.VarChar(50)
  itemNo          Int              @map("item_no")
  description     String           @db.Text
  requiresCustoms Boolean          @default(false) @map("requires_customs")
  createdAt       DateTime         @default(now()) @map("created_at")

  // Relations
  orders          Order[]

  @@unique([regionFrom, regionTo])
  @@map("shipping_scenarios")
}

model ShippingAccount {
  id            String      @id @default(cuid())
  carrier       CarrierType
  accountNumber String      @map("account_number") @db.VarChar(100)
  accountName   String?     @map("account_name") @db.VarChar(255)
  description   String?     @db.Text
  isDefault     Boolean     @default(false) @map("is_default")
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  outboundBoxes OrderBox[]  @relation("OutboundAccount")
  sampleBoxes   OrderBox[]  @relation("SampleAccount")

  @@map("shipping_accounts")
}

// ═══════════════════════════════════════════════════════════════════
// SITES
// ═══════════════════════════════════════════════════════════════════

model Site {
  id            String    @id @default(cuid())
  legacyId      String?   @unique @map("legacy_id") @db.VarChar(50)
  name          String
  code          String    @unique
  companyOrName String?   @map("company_or_name") @db.VarChar(255)

  // Contact Information
  telephone     String?   @db.VarChar(50)
  telephoneExt  String?   @map("telephone_ext") @db.VarChar(20)
  consigneeEmail String?  @map("consignee_email") @db.VarChar(255)

  // Address
  addressLine1  String    @map("address_line1")
  addressLine2  String?   @map("address_line2")
  addressLine3  String?   @map("address_line3") @db.VarChar(255)
  city          String
  stateProvince String?   @map("state_province")
  postalCode    String    @map("postal_code")
  countryCode   String    @map("country_code")
  countryName   String    @map("country_name")
  residentialInd Boolean  @default(false) @map("residential_ind")
  deliveryAddress String? @map("delivery_address") @db.Text

  // Alternative Names (for label generation)
  fromSiteName  String?   @map("from_site_name") @db.VarChar(255)
  fromSite2     String?   @map("from_site_2") @db.VarChar(255)
  fromSite3     String?   @map("from_site_3") @db.VarChar(255)
  fromSite4     String?   @map("from_site_4") @db.VarChar(255)
  fromSite5     String?   @map("from_site_5") @db.VarChar(255)

  // Pickup/Collection Information
  pickupTimeFrom String?  @map("pickup_time_from") @db.VarChar(10)
  pickupTimeTo   String?  @map("pickup_time_to") @db.VarChar(10)
  preferredCollectionLocation String? @map("preferred_collection_location") @db.Text

  // Region Classification
  region        GeographicRegion?
  isEU          Boolean   @default(true) @map("is_eu")

  // Default Forwarders
  outboundVia   CarrierType? @map("outbound_via")
  sampleVia     CarrierType? @map("sample_via")

  // Status
  isActive      Boolean   @default(true) @map("is_active")

  // Notes
  notes         String?   @db.Text
  internalNotes String?   @map("internal_notes") @db.Text
  additionalNotes String? @map("additional_notes") @db.Text

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  country       Country?  @relation(fields: [countryCode], references: [code])
  contacts      SiteContact[]
  orders        Order[]

  @@index([code])
  @@index([legacyId])
  @@index([countryCode])
  @@index([region])
  @@index([isActive])
  @@map("sites")
}

model SiteContact {
  id          String    @id @default(cuid())
  siteId      String    @map("site_id")
  name        String
  email       String
  phone       String?
  department  String?
  isPrimary   Boolean   @default(false) @map("is_primary")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  site        Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  orders      Order[]   @relation("SiteContactOrders")
  
  @@index([siteId])
  @@map("site_contacts")
}

// ═══════════════════════════════════════════════════════════════════
// LABORATORIES
// ═══════════════════════════════════════════════════════════════════

model Lab {
  id            String    @id @default(cuid())
  legacyId      String?   @unique @map("legacy_id") @db.VarChar(50)
  name          String
  code          String    @unique
  companyOrName String?   @map("company_or_name") @db.VarChar(255)

  // Contact Information
  telephone     String?   @db.VarChar(50)
  telephoneExt  String?   @map("telephone_ext") @db.VarChar(20)
  consigneeEmail String?  @map("consignee_email") @db.VarChar(255)

  // Address
  addressLine1  String    @map("address_line1")
  addressLine2  String?   @map("address_line2")
  addressLine3  String?   @map("address_line3") @db.VarChar(255)
  city          String
  stateProvince String?   @map("state_province")
  postalCode    String    @map("postal_code")
  countryCode   String    @map("country_code")
  countryName   String    @map("country_name")
  residentialInd Boolean  @default(false) @map("residential_ind")
  deliveryAddress String? @map("delivery_address") @db.Text
  preferredCollectionLocation String? @map("preferred_collection_location") @db.Text

  // Region Classification
  region        GeographicRegion?
  isEU          Boolean   @default(true) @map("is_eu")

  // Status
  isActive      Boolean   @default(true) @map("is_active")

  // Notes
  notes         String?   @db.Text
  internalNotes String?   @map("internal_notes") @db.Text

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  country       Country?  @relation(fields: [countryCode], references: [code])
  contacts      LabContact[]
  orders        Order[]

  @@index([code])
  @@index([legacyId])
  @@index([countryCode])
  @@index([region])
  @@index([isActive])
  @@map("labs")
}

model LabContact {
  id          String    @id @default(cuid())
  labId       String    @map("lab_id")
  name        String
  email       String
  phone       String?
  department  String?
  isPrimary   Boolean   @default(false) @map("is_primary")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  lab         Lab       @relation(fields: [labId], references: [id], onDelete: Cascade)
  orders      Order[]   @relation("LabContactOrders")
  
  @@index([labId])
  @@map("lab_contacts")
}

// ═══════════════════════════════════════════════════════════════════
// KITS & STOCK
// ═══════════════════════════════════════════════════════════════════

model Kit {
  id            String    @id @default(cuid())
  legacyNr      Int?      @unique @map("legacy_nr")
  name          String
  code          String    @unique
  description   String?   @db.Text

  // Box Dimensions (outer box that contains the kit)
  boxLengthCm   Float?    @map("box_length_cm")
  boxWidthCm    Float?    @map("box_width_cm")
  boxHeightCm   Float?    @map("box_height_cm")
  boxWeightEmptyGrams Float? @map("box_weight_empty_grams")

  // Legacy dimensions (kept for backwards compatibility)
  totalWeight   Float     @map("total_weight")
  length        Float
  width         Float
  height        Float

  // Calculated total weight (including all items)
  totalWeightGrams Float? @map("total_weight_grams")

  // Templates
  boxContentTemplateOutbound String? @map("box_content_template_outbound") @db.VarChar(255)
  boxContentTemplateSample   String? @map("box_content_template_sample") @db.VarChar(255)
  templatePath  String?   @map("template_path") @db.Text

  // Shipping Properties
  isUrgent      Boolean   @default(false) @map("is_urgent")
  requiresCustomsDocs Boolean @default(false) @map("requires_customs_docs")
  requiresNonadr Boolean  @default(false) @map("requires_nonadr")

  // Status
  isActive      Boolean   @default(true) @map("is_active")
  notes         String?   @db.Text

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  items         KitItem[]
  orders        Order[]
  labelTemplates LabelTemplate[]

  @@index([code])
  @@index([legacyNr])
  @@index([isActive])
  @@map("kits")
}

// ═══════════════════════════════════════════════════════════════════
// LABEL TEMPLATES (for document generation)
// ═══════════════════════════════════════════════════════════════════

model LabelTemplate {
  id              String            @id @default(cuid())
  name            String            @unique
  type            LabelTemplateType
  description     String?           @db.Text

  // Layout configuration (JSON structure for field positions, styling)
  layoutConfig    Json?             @map("layout_config")

  // Content options
  includeContractInfo   Boolean     @default(true) @map("include_contract_info")
  includeItemsTable     Boolean     @default(true) @map("include_items_table")
  includeBarcode        Boolean     @default(false) @map("include_barcode")
  includeLogo           Boolean     @default(true) @map("include_logo")

  // Custom text overrides
  headerText      String?           @map("header_text") @db.VarChar(255)
  footerText      String?           @map("footer_text") @db.Text

  // Page settings
  pageSize        String            @default("A4") @map("page_size") @db.VarChar(20)
  orientation     String            @default("portrait") @db.VarChar(20)

  // Linked kit (optional - can be default/global template)
  kitId           String?           @map("kit_id")
  kit             Kit?              @relation(fields: [kitId], references: [id])

  // Status
  isDefault       Boolean           @default(false) @map("is_default")
  isActive        Boolean           @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@index([type])
  @@index([kitId])
  @@index([isDefault, type])
  @@map("label_templates")
}

model StockItem {
  id              String    @id @default(cuid())
  name            String
  sku             String    @unique
  description     String?   @db.Text
  category        ItemCategory @default(OTHER)

  // Inventory
  quantity        Int       @default(0)
  minStockLevel   Int       @default(0) @map("min_stock_level")

  // Pricing (for commercial invoice)
  unitPrice       Float     @map("unit_price")
  currency        String    @default("EUR")

  // Physical properties
  unitWeight      Float     @map("unit_weight")
  weightGrams     Float?    @map("weight_grams")
  length          Float?
  width           Float?
  height          Float?
  volumeMl        Float?    @map("volume_ml")

  // Supplier Information
  supplierName    String?   @map("supplier_name") @db.VarChar(255)
  supplierItemCode String?  @map("supplier_item_code") @db.VarChar(100)

  // Customs/Shipping Info (for international shipments)
  hsCode          String?   @map("hs_code") @db.VarChar(20)
  countryOfOriginCode String? @map("country_of_origin_code") @db.Char(2)
  customsDescription String? @map("customs_description") @db.Text
  customsValueEur Float?    @map("customs_value_eur")

  // Regulatory/Safety
  isDangerousGoods Boolean  @default(false) @map("is_dangerous_goods")
  unNumber        String?   @map("un_number") @db.VarChar(10)
  requiresColdChain Boolean @default(false) @map("requires_cold_chain")
  storageTempMinC Float?    @map("storage_temp_min_c")
  storageTempMaxC Float?    @map("storage_temp_max_c")

  // Status
  isActive        Boolean   @default(true) @map("is_active")
  notes           String?   @db.Text

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  countryOfOrigin Country?  @relation("ItemCountryOfOrigin", fields: [countryOfOriginCode], references: [code])
  kitItems        KitItem[]
  movements       StockMovement[]

  @@index([sku])
  @@index([category])
  @@index([quantity, minStockLevel])
  @@map("stock_items")
}

model KitItem {
  id            String    @id @default(cuid())
  kitId         String    @map("kit_id")
  stockItemId   String    @map("stock_item_id")
  quantity      Int       @default(1)
  isRequired    Boolean   @default(true) @map("is_required")
  sortOrder     Int       @default(0) @map("sort_order")
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  kit           Kit       @relation(fields: [kitId], references: [id], onDelete: Cascade)
  stockItem     StockItem @relation(fields: [stockItemId], references: [id])

  @@unique([kitId, stockItemId])
  @@index([kitId])
  @@index([stockItemId])
  @@map("kit_items")
}

model StockMovement {
  id              String            @id @default(cuid())
  stockItemId     String            @map("stock_item_id")
  orderId         String?           @map("order_id")
  quantityChange  Int               @map("quantity_change")
  movementType    StockMovementType @map("movement_type")
  notes           String?           @db.Text
  
  // Audit
  createdAt       DateTime          @default(now()) @map("created_at")
  createdById     String?           @map("created_by_id")
  
  // Relations
  stockItem       StockItem         @relation(fields: [stockItemId], references: [id])
  order           Order?            @relation(fields: [orderId], references: [id])
  createdBy       User?             @relation(fields: [createdById], references: [id])
  
  @@index([stockItemId])
  @@index([orderId])
  @@index([createdAt])
  @@map("stock_movements")
}

// ═══════════════════════════════════════════════════════════════════
// ORDERS
// ═══════════════════════════════════════════════════════════════════

model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique @map("order_number")

  // References
  siteId            String        @map("site_id")
  labId             String        @map("lab_id")
  kitId             String        @map("kit_id")
  siteContactId     String        @map("site_contact_id")
  labContactId      String        @map("lab_contact_id")
  shippingScenarioId String?      @map("shipping_scenario_id")

  // Order details
  quantity          Int           @default(1)
  status            OrderStatus   @default(DRAFT)
  sampleType        String?       @map("sample_type") @db.VarChar(100)
  outboundType      String?       @map("outbound_type") @db.VarChar(100)

  // Key dates
  samplingDate      DateTime      @map("sampling_date")
  outboundShipDate  DateTime      @map("outbound_ship_date")
  confirmedSamplingDate DateTime? @map("confirmed_sampling_date")
  confirmedPickupDate DateTime?   @map("confirmed_pickup_date")
  outboundShippingDate DateTime?  @map("outbound_shipping_date")

  // Carrier selection
  outboundCarrier   CarrierType   @map("outbound_carrier")
  sampleCarrier     CarrierType   @map("sample_carrier")

  // Collection Info
  collectionBookedById String?    @map("collection_booked_by_id")
  collectionBookedByName String?  @map("collection_booked_by_name") @db.VarChar(255)
  collectionId      String?       @map("collection_id") @db.VarChar(100)

  // Customs
  requiresCustomsDocs Boolean     @default(false) @map("requires_customs_docs")

  // Approval
  approvedAt        DateTime?     @map("approved_at")
  approvedById      String?       @map("approved_by_id")

  // Notes
  notes             String?       @db.Text

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  site              Site          @relation(fields: [siteId], references: [id])
  lab               Lab           @relation(fields: [labId], references: [id])
  kit               Kit           @relation(fields: [kitId], references: [id])
  siteContact       SiteContact   @relation("SiteContactOrders", fields: [siteContactId], references: [id])
  labContact        LabContact    @relation("LabContactOrders", fields: [labContactId], references: [id])
  shippingScenario  ShippingScenario? @relation(fields: [shippingScenarioId], references: [id])
  approvedBy        User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
  collectionBookedBy User?        @relation("CollectionBookedBy", fields: [collectionBookedById], references: [id])

  shipments         Shipment[]
  documents         Document[]
  stockMovements    StockMovement[]
  orderBoxes        OrderBox[]

  @@index([status])
  @@index([samplingDate])
  @@index([outboundShipDate])
  @@index([siteId])
  @@index([labId])
  @@index([shippingScenarioId])
  @@index([createdAt])
  @@map("orders")
}

// ═══════════════════════════════════════════════════════════════════
// ORDER BOXES (Critical: Links Outbound + Sample Waybills)
// ═══════════════════════════════════════════════════════════════════

model OrderBox {
  id            String    @id @default(cuid())
  orderId       String    @map("order_id")
  boxNumber     Int       @map("box_number")

  // OUTBOUND SHIPMENT INFO
  outboundWaybill String? @map("outbound_waybill") @db.VarChar(100)
  outboundLabelCreatedById String? @map("outbound_label_created_by_id")
  outboundLabelCreatedByName String? @map("outbound_label_created_by_name") @db.VarChar(255)
  outboundAccountId String? @map("outbound_account_id")
  outboundAccountName String? @map("outbound_account_name") @db.VarChar(255)
  boxContentGeneratedOutbound Boolean @default(false) @map("box_content_generated_outbound")
  outboundLabelCreatedAt DateTime? @map("outbound_label_created_at")

  // SAMPLE SHIPMENT INFO
  sampleWaybill String?   @map("sample_waybill") @db.VarChar(100)
  sampleLabelCreatedById String? @map("sample_label_created_by_id")
  sampleLabelCreatedByName String? @map("sample_label_created_by_name") @db.VarChar(255)
  sampleAccountId String?  @map("sample_account_id")
  sampleAccountName String? @map("sample_account_name") @db.VarChar(255)
  boxContentGeneratedSample Boolean @default(false) @map("box_content_generated_sample")
  nonadrGenerated Boolean  @default(false) @map("nonadr_generated")
  sampleLabelCreatedAt DateTime? @map("sample_label_created_at")

  // BOX CONTENTS (Barcodes/Samples)
  barcodeSequence String?  @map("barcode_sequence") @db.VarChar(255)
  barcodeStart    String?  @map("barcode_start") @db.VarChar(50)
  barcodeEnd      String?  @map("barcode_end") @db.VarChar(50)
  barcodeCount    Int?     @map("barcode_count")
  barcodeDetails  Json?    @map("barcode_details")

  // WAREHOUSE OPERATIONS
  boxPickedById   String?  @map("box_picked_by_id")
  boxPickedByName String?  @map("box_picked_by_name") @db.VarChar(255)
  boxPickedAt     DateTime? @map("box_picked_at")
  boxCheckedById  String?  @map("box_checked_by_id")
  boxCheckedByName String? @map("box_checked_by_name") @db.VarChar(255)
  boxCheckedAt    DateTime? @map("box_checked_at")

  // NOTIFICATIONS
  notifiedSimona  Boolean  @default(false) @map("notified_simona")
  notifiedAt      DateTime? @map("notified_at")

  // STATUS & EXCEPTIONS
  status          BoxStatus @default(PENDING)
  exception       String?  @db.Text

  // DATA QUALITY FLAGS (for migration from Excel)
  isMigratedData  Boolean  @default(false) @map("is_migrated_data")
  waybillMatchVerified Boolean @default(true) @map("waybill_match_verified")
  verificationNotes String? @map("verification_notes") @db.Text
  verifiedById    String?  @map("verified_by_id")
  verifiedAt      DateTime? @map("verified_at")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  outboundLabelCreatedBy User? @relation("OutboundLabelCreatedBy", fields: [outboundLabelCreatedById], references: [id])
  sampleLabelCreatedBy User? @relation("SampleLabelCreatedBy", fields: [sampleLabelCreatedById], references: [id])
  outboundAccount ShippingAccount? @relation("OutboundAccount", fields: [outboundAccountId], references: [id])
  sampleAccount   ShippingAccount? @relation("SampleAccount", fields: [sampleAccountId], references: [id])
  boxPickedBy     User?    @relation("BoxPickedBy", fields: [boxPickedById], references: [id])
  boxCheckedBy    User?    @relation("BoxCheckedBy", fields: [boxCheckedById], references: [id])
  verifiedBy      User?    @relation("BoxVerifiedBy", fields: [verifiedById], references: [id])

  boxImages       BoxImage[]
  boxDocuments    BoxDocument[]

  @@unique([orderId, boxNumber])
  @@index([orderId])
  @@index([outboundWaybill])
  @@index([sampleWaybill])
  @@index([status])
  @@index([barcodeSequence])
  @@map("order_boxes")
}

model BoxImage {
  id          String    @id @default(cuid())
  boxId       String    @map("box_id")
  imageType   String    @map("image_type") @db.VarChar(50)
  fileName    String    @map("file_name") @db.VarChar(255)
  filePath    String    @map("file_path") @db.VarChar(500)
  fileSize    Int?      @map("file_size")
  mimeType    String?   @map("mime_type") @db.VarChar(100)
  description String?   @db.Text
  uploadedById String?  @map("uploaded_by_id")
  uploadedAt  DateTime  @default(now()) @map("uploaded_at")

  // Relations
  box         OrderBox  @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId])
  @@map("box_images")
}

model BoxDocument {
  id            String    @id @default(cuid())
  boxId         String    @map("box_id")
  documentType  String    @map("document_type") @db.VarChar(50)
  fileName      String    @map("file_name") @db.VarChar(255)
  filePath      String    @map("file_path") @db.VarChar(500)
  fileSize      Int?      @map("file_size")
  mimeType      String?   @map("mime_type") @db.VarChar(100)
  description   String?   @db.Text
  generatedById String?   @map("generated_by_id")
  generatedAt   DateTime  @default(now()) @map("generated_at")

  // Relations
  box           OrderBox  @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId])
  @@map("box_documents")
}

// ═══════════════════════════════════════════════════════════════════
// SHIPMENTS
// ═══════════════════════════════════════════════════════════════════

model Shipment {
  id                    String          @id @default(cuid())
  orderId               String          @map("order_id")
  type                  ShipmentType
  carrier               CarrierType
  status                ShipmentStatus  @default(PENDING)
  
  // Tracking
  trackingNumber        String?         @map("tracking_number")
  waybillNumber         String?         @map("waybill_number")
  
  // Dates
  scheduledShipDate     DateTime        @map("scheduled_ship_date")
  expectedDeliveryDate  DateTime?       @map("expected_delivery_date")
  actualShipDate        DateTime?       @map("actual_ship_date")
  actualDeliveryDate    DateTime?       @map("actual_delivery_date")
  
  // Proof of Delivery
  podRetrieved          Boolean         @default(false) @map("pod_retrieved")
  podRetrievedAt        DateTime?       @map("pod_retrieved_at")
  podSignedBy           String?         @map("pod_signed_by")
  
  // Carrier response data
  carrierResponseJson   Json?           @map("carrier_response_json")
  
  // Timestamps
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  
  // Relations
  order                 Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  documents             Document[]
  trackingEvents        TrackingEvent[]
  
  @@unique([orderId, type])
  @@index([trackingNumber])
  @@index([status])
  @@index([scheduledShipDate])
  @@map("shipments")
}

model TrackingEvent {
  id                String    @id @default(cuid())
  shipmentId        String    @map("shipment_id")
  eventCode         String    @map("event_code")
  eventDescription  String    @map("event_description")
  location          String?
  eventDate         DateTime  @map("event_date")
  rawData           Json?     @map("raw_data")
  createdAt         DateTime  @default(now()) @map("created_at")
  
  // Relations
  shipment          Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  @@index([shipmentId])
  @@index([eventDate])
  @@map("tracking_events")
}

// ═══════════════════════════════════════════════════════════════════
// DOCUMENTS
// ═══════════════════════════════════════════════════════════════════

model Document {
  id            String        @id @default(cuid())
  orderId       String        @map("order_id")
  shipmentId    String?       @map("shipment_id")
  type          DocumentType
  fileName      String        @map("file_name")
  filePath      String        @map("file_path")
  fileType      String        @map("file_type")
  fileSize      Int           @map("file_size")
  generatedAt   DateTime      @default(now()) @map("generated_at")
  
  // Relations
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shipment      Shipment?     @relation(fields: [shipmentId], references: [id])
  
  @@index([orderId])
  @@index([orderId, type])
  @@map("documents")
}

// ═══════════════════════════════════════════════════════════════════
// CONFIGURATION
// ═══════════════════════════════════════════════════════════════════

model Setting {
  id        String    @id @default(cuid())
  key       String    @unique
  value     String    @db.Text
  category  String    @default("general")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  
  @@index([category])
  @@map("settings")
}

model CarrierConfig {
  id            String        @id @default(cuid())
  carrier       CarrierType
  shipmentType  ShipmentType  @map("shipment_type")
  configJson    Json          @map("config_json")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  @@unique([carrier, shipmentType])
  @@map("carrier_configs")
}

model DocumentTemplate {
  id            String        @id @default(cuid())
  name          String
  type          DocumentType
  filePath      String        @map("file_path")
  configJson    Json?         @map("config_json")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  @@index([type])
  @@map("document_templates")
}

model HadeaConfig {
  id                        String    @id @default(cuid())
  contractingAuthorityName  String    @map("contracting_authority_name")
  contractorName            String    @map("contractor_name")
  specificContractNumber    String    @map("specific_contract_number")
  specificContractDate      DateTime  @map("specific_contract_date")
  shippingAddress           String?   @map("shipping_address") @db.Text
  isActive                  Boolean   @default(true) @map("is_active")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  @@map("hadea_configs")
}

// ═══════════════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════════════

model AuditLog {
  id            String      @id @default(cuid())
  entityType    String      @map("entity_type") @db.VarChar(50)
  entityId      String      @map("entity_id")
  action        AuditAction
  changedFields Json?       @map("changed_fields")
  oldValues     Json?       @map("old_values")
  newValues     Json?       @map("new_values")
  changedById   String?     @map("changed_by_id")
  changedAt     DateTime    @default(now()) @map("changed_at")
  ipAddress     String?     @map("ip_address") @db.VarChar(45)
  userAgent     String?     @map("user_agent") @db.Text

  // Relations
  changedBy     User?       @relation(fields: [changedById], references: [id])

  @@index([entityType, entityId])
  @@index([changedAt])
  @@index([changedById])
  @@map("audit_log")
}
